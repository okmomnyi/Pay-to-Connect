{
  "meta": {
    "project": "Estate Wi-Fi Captive Portal & Billing System",
    "date": "2025-12-30",
    "prepared_by": "Generated by TestSprite"
  },
  "product_overview": "A production-ready Wi-Fi captive portal billing system that enables internet access control using time-based paid packages integrated with M-Pesa payments. Designed for estate-level, hotspot, or small ISP deployments, it offers a secure, scalable, and maintainable solution to manage user access and billing with minimal human intervention.",
  "core_goals": [
    "Enforce paid internet access through time-based packages",
    "Integrate seamless M-Pesa STK Push payments",
    "Automatically grant and revoke internet access based on session status",
    "Support multiple router types with router-agnostic design",
    "Deliver an admin dashboard for comprehensive management of packages, users, payments, and sessions",
    "Provide a user-friendly captive portal for browsing packages, making payments, and checking device status",
    "Ensure system scalability, security, and maintainability",
    "Allow full client handover post-deployment"
  ],
  "key_features": [
    "User authentication with JWT and password hashing",
    "Admin panel with package management, user session monitoring, and payment overview",
    "User-facing captive portal with package browsing, payment initiation, and connection detection",
    "M-Pesa payment integration using STK Push, callback validation, and payment status tracking",
    "Session management without Redis dependency, including session creation, validation and expiry handling",
    "Router integration supporting MikroTik, OpenWRT, and pfSense with traffic control based on session status",
    "Database-driven state management using PostgreSQL with optional Redis caching",
    "Device and MAC address registration with user association",
    "Security middleware including rate limiting, CORS, and helmet headers",
    "Logging system with Winston for debugging and monitoring"
  ],
  "user_flow_summary": [
    "User connects to Wi-Fi and is redirected to the captive portal if unauthenticated",
    "User views available internet packages with prices and durations",
    "User selects a package and enters a valid Kenyan phone number for payment",
    "System triggers an M-Pesa STK Push payment request",
    "User receives payment prompt on phone and completes or cancels payment",
    "Backend validates payment via callback, creates internet session on success",
    "User gains immediate internet access for the purchased time duration",
    "Session validity checked on each connection attempt; access revoked upon expiry",
    "Admin logs into dashboard to manage packages, monitor active sessions, view payments, and disconnect users if needed"
  ],
  "validation_criteria": [
    "User cannot browse internet before successful payment",
    "STK Push payment is sent within 5 seconds of request",
    "Phone number input validated against Kenyan format",
    "Duplicate and invalid payments are prevented",
    "Only successful payment callbacks create active internet sessions",
    "Expired or inactive sessions do not grant internet access",
    "Admin actions such as package creation, user disconnection, and payment viewing function correctly",
    "Payment processing completes under 5 seconds and session checks under 100ms",
    "System handles duplicate callbacks, server restarts, and network failures gracefully"
  ],
  "code_summary": {
    "tech_stack": [
      "TypeScript",
      "Node.js",
      "Express.js",
      "PostgreSQL",
      "Redis",
      "RADIUS",
      "M-Pesa API",
      "TailwindCSS",
      "HTML5",
      "JavaScript"
    ],
    "features": [
      {
        "name": "User Authentication",
        "description": "User login and registration system with JWT tokens, password hashing with bcrypt, and session management",
        "files": [
          "src/controllers/userController.ts",
          "src/routes/user.ts",
          "src/middleware/userAuth.ts",
          "public/login.html",
          "public/login.js"
        ]
      },
      {
        "name": "Admin Panel",
        "description": "Admin authentication and dashboard for managing packages, routers, sessions, and payments with comprehensive statistics",
        "files": [
          "src/controllers/adminController.ts",
          "src/routes/admin.ts",
          "src/middleware/auth.ts",
          "public/admin.html",
          "public/admin.js"
        ]
      },
      {
        "name": "Portal Interface",
        "description": "User-facing portal for viewing packages, initiating payments, and checking device status",
        "files": [
          "src/controllers/portalController.ts",
          "src/routes/portal.ts",
          "public/index.html",
          "public/app.js"
        ]
      },
      {
        "name": "Package Management",
        "description": "CRUD operations for Wi-Fi access packages with duration and pricing",
        "files": [
          "src/controllers/adminController.ts",
          "src/routes/admin.ts"
        ]
      },
      {
        "name": "M-Pesa Payment Integration",
        "description": "M-Pesa STK push payment processing, callback handling, and payment status tracking",
        "files": [
          "src/services/mpesa.ts",
          "src/services/mockMpesa.ts",
          "src/controllers/portalController.ts"
        ]
      },
      {
        "name": "RADIUS Server",
        "description": "RADIUS authentication server for network access control and session management",
        "files": [
          "src/services/radius.ts",
          "src/services/mockRadius.ts",
          "src/services/radiusServerless.ts"
        ]
      },
      {
        "name": "Router Management",
        "description": "Management of MikroTik routers including configuration and monitoring",
        "files": [
          "src/controllers/adminController.ts",
          "src/routes/admin.ts"
        ]
      },
      {
        "name": "Session Management",
        "description": "Active session tracking, expiration handling, and device session monitoring",
        "files": [
          "src/services/radius.ts",
          "src/controllers/adminController.ts"
        ]
      },
      {
        "name": "Database Connection",
        "description": "PostgreSQL database connection pooling with optional Redis caching",
        "files": [
          "src/database/connection.ts",
          "src/database/migrate.ts"
        ]
      },
      {
        "name": "Device Management",
        "description": "Device registration, MAC address tracking, and user device associations",
        "files": [
          "src/controllers/userController.ts",
          "src/controllers/portalController.ts"
        ]
      },
      {
        "name": "Payment Monitoring",
        "description": "Payment history tracking, revenue statistics, and transaction monitoring",
        "files": [
          "src/controllers/adminController.ts",
          "src/routes/admin.ts"
        ]
      },
      {
        "name": "Security Middleware",
        "description": "Rate limiting, CORS, helmet security headers, and authentication middleware",
        "files": [
          "src/server.ts",
          "src/middleware/auth.ts",
          "src/middleware/userAuth.ts"
        ]
      },
      {
        "name": "Logging System",
        "description": "Winston-based logging with file and console outputs for debugging and monitoring",
        "files": [
          "src/utils/logger.ts"
        ]
      }
    ]
  }
}
